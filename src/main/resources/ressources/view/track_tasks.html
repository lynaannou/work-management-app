<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECLIPSEWORK - Task List</title>

    <!-- ================== STYLES (UNCHANGED) ================== -->
    <style>
        :root {
            --primary: #0078D4;
            --secondary: #6B8EBB;
            --light: #F8F9FA;
            --dark: #343A40;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --border: #DEE2E6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0078D4 0%, #ffffff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
        }

        .tasks-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tasks-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
        }

        .tasks-table td {
            padding: 14px;
            border-bottom: 1px solid var(--border);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-todo { background:#fff3cd; color:#856404; }
        .status-inprogress { background:#cce5ff; color:#004085; }
        .status-done { background:#d4edda; color:#155724; }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;

    margin-bottom: 22px;
    padding: 6px 14px;

    background: rgba(0, 0, 0, 0.03);
    color: #333;

    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 10px;

    font-family: 'Poppins', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;

    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
}

.back-btn:hover {
    background: rgba(0, 0, 0, 0.06);
    color: #000;
}

.back-btn:active {
    transform: translateX(-2px);
}

.back-btn::before {
    content: "←";
    font-size: 1rem;
    opacity: 0.6;
}

        .edit-btn { background:#4A6FA533; color:#4A6FA5; }
        .delete-btn { background:#dc354533; color:#DC3545; }
    </style>
</head>

<body>

<!-- ================== NAVBAR ================== -->
<nav class="navbar">
    <div class="logo">ECLIPSEWORK</div>
</nav>

<!-- ================== TABLE ================== -->
<div class="table-container">
    <button class="back-btn" onclick="goProjects()">Back to Projects</button>
    <h1 style="margin-bottom:20px;">TASK LIST</h1>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    

    <button
        onclick="addTask()"
        style="
            background:#2563eb;
            color:white;
            border:none;
            padding:10px 16px;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        ">
        ➕ Add Task
    </button>
</div>


    <table class="tasks-table">
        <thead>
        <tr>
            <th>TASK</th>
            <th>DESCRIPTION</th>
            <th>DUE</th>
            <th>STATUS</th>
            <th>ACTIONS</th>
        </tr>
        </thead>
        <tbody id="tasksTableBody"></tbody>
    </table>
</div>

<!-- ================== SCRIPT ================== -->
<script>
function goProjects() {
    window.java?.goProjects?.();
}

let currentTasks = [];

/* ---------- LOAD TASKS ---------- */
function loadTasks() {
    if (!window.currentTeamId) {
        console.warn("⏳ Waiting for currentTeamId...");
        return;
    }

    try {
        console.log("✅ Loading tasks for team", window.currentTeamId);

        const json = window.javaBridge.loadTasksAsJson(window.currentTeamId);
        console.log("RAW JSON FROM JAVA =", json);

        currentTasks = JSON.parse(json);
        renderTasks();

    } catch (e) {
        console.error("❌ loadTasks failed", e);
        document.getElementById("tasksTableBody").innerHTML =
            `<tr><td colspan="5">❌ Failed to load tasks</td></tr>`;
    }
}

/* ---------- RENDER ---------- */
function renderTasks() {
    const tbody = document.getElementById("tasksTableBody");

    if (!currentTasks || currentTasks.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">No tasks yet</td></tr>`;
        return;
    }

    tbody.innerHTML = currentTasks.map(t => `
        <tr>
            <td><strong>${t.title}</strong></td>
            <td>${t.description || "-"}</td>
            <td>${t.dueDate || "-"}</td>
            <td>
                <span class="status-badge status-${t.status.toLowerCase().replace("_","")}">
                    ${t.status.replace("_"," ")}
                </span>
            </td>
            <td>
                <button class="action-btn edit-btn"
                        onclick="editTask(${t.id})">
                    Edit
                </button>
                <button class="action-btn delete-btn"
                        onclick="deleteTask(${t.id})">
                    Delete
                </button>
            </td>
        </tr>
    `).join("");
}

/* ---------- DELETE TASK (SINGLE SOURCE OF TRUTH) ---------- */
function deleteTask(id) {
    alert("DELETE CLICKED: " + id);
    if (!confirm("Delete this task?")) return;

    const ok = window.javaBridge.deleteTaskById(id);

    if (ok) {
        loadTasks(); // refresh UI
    } else {
        alert("❌ Delete failed");
    }
}


/* ---------- EDIT TASK ---------- */
function editTask(taskId) {
    console.log("✏️ Edit task", taskId);

    if (window.javaBridge?.openEditTask) {
        window.javaBridge.openEditTask(window.currentTeamId, taskId);
    }
}

/* ---------- SAFE INIT (JavaFX) ---------- */
function waitForTeamId() {
    if (window.currentTeamId && window.javaBridge) {
        loadTasks();
    } else {
        setTimeout(waitForTeamId, 50);
    }
}

document.addEventListener("DOMContentLoaded", waitForTeamId);

/* ---------- ADD TASK ---------- */
function addTask() {
    if (!window.currentTeamId) {
        alert("No project selected");
        return;
    }

    if (window.javaBridge?.openNewTaskForm) {
        window.javaBridge.openNewTaskForm(window.currentTeamId);
    } else {
        console.error("❌ openNewTaskForm not available");
    }
}
</script>

</body>
</html>
